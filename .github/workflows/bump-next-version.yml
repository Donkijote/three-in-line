name: Bump Next Version

on:
  workflow_run:
    workflows:
      - Deploy to Cloudflare Spa
    types:
      - completed

concurrency:
  group: bump-next-version
  cancel-in-progress: true

jobs:
  bump-version:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ssh-key: ${{ secrets.RELEASE_BOT_DEPLOY_KEY }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.6

      - name: Configure SSH signing
        env:
          RELEASE_BOT_SIGNING_KEY: ${{ secrets.RELEASE_BOT_SIGNING_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$RELEASE_BOT_SIGNING_KEY" > ~/.ssh/release_bot_signing_key
          chmod 600 ~/.ssh/release_bot_signing_key
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git config gpg.format ssh
          git config user.signingkey ~/.ssh/release_bot_signing_key
          git config commit.gpgsign true

      - name: Read release PR info
        id: release_pr
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            let pr = run.pull_requests?.[0];
            if (!pr?.number && run.head_branch) {
              const { data } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "closed",
                head: `${context.repo.owner}:${run.head_branch}`,
                base: "main",
                per_page: 1,
              });
              pr = data[0];
            }
            if (!pr?.number) {
              core.setOutput("is_release", "false");
              return;
            }
            const isRelease = pr.head?.ref?.startsWith("release/") ?? false;
            core.setOutput("is_release", isRelease ? "true" : "false");
            core.setOutput("pr_number", String(pr.number));

      - name: Read release labels
        id: release_labels
        if: steps.release_pr.outputs.is_release == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number("${{ steps.release_pr.outputs.pr_number }}");
            const { data } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            const labels = data.map((label) => label.name);
            core.setOutput("labels", labels.join(","));

      - name: Determine bump type
        id: bump
        if: steps.release_pr.outputs.is_release == 'true'
        env:
          RELEASE_LABELS: ${{ steps.release_labels.outputs.labels }}
        run: |
          bump="$(bun -e 'const labels = process.env.RELEASE_LABELS.split(",").filter(Boolean);
          const options = ["major", "minor", "patch"];
          const match = options.find((name) => labels.includes(`release/${name}`));
          if (!match) {
            console.error("Missing release label: release/major, release/minor, or release/patch.");
            process.exit(1);
          }
          const forced = labels.includes("release-mode/force");
          const bump = forced && match === "major" ? "minor" : match;
          console.log(bump);')"
          echo "value=${bump}" >> "$GITHUB_OUTPUT"

      - name: Read released version
        id: released_version
        if: steps.release_pr.outputs.is_release == 'true'
        run: |
          version="$(git show origin/main:package.json | bun -e 'import { readFileSync } from "node:fs";
          const data = readFileSync(0, "utf8");
          console.log(JSON.parse(data).version);')"
          echo "value=${version}" >> "$GITHUB_OUTPUT"

      - name: Checkout main
        if: steps.release_pr.outputs.is_release == 'true'
        run: |
          git fetch origin main --prune
          git checkout main
          git pull --ff-only origin main

      - name: Bump package version
        id: next_version
        if: steps.release_pr.outputs.is_release == 'true'
        env:
          BASE_VERSION: ${{ steps.released_version.outputs.value }}
          BUMP_TYPE: ${{ steps.bump.outputs.value }}
        run: |
          current="$(bun -e 'import pkg from "./package.json" assert { type: "json" }; console.log(pkg.version);')"
          if [ "$current" != "$BASE_VERSION" ]; then
            bun pm version --no-git-tag-version "$BASE_VERSION"
          fi
          bun pm version --no-git-tag-version "$BUMP_TYPE"
          next="$(bun -e 'import pkg from "./package.json" assert { type: "json" }; console.log(pkg.version);')"
          echo "value=${next}" >> "$GITHUB_OUTPUT"

      - name: Create bump branch
        id: bump_branch
        if: steps.release_pr.outputs.is_release == 'true'
        run: |
          branch="chore/bump-version-${{ steps.next_version.outputs.value }}"
          git checkout -b "$branch"
          echo "name=${branch}" >> "$GITHUB_OUTPUT"

      - name: Commit bump
        if: steps.release_pr.outputs.is_release == 'true'
        env:
          NEXT_VERSION: ${{ steps.next_version.outputs.value }}
        run: |
          git config user.name "Manuel GonÃ§alves"
          git config user.email "manuelmjgc@gmail.com"
          git add package.json
          git commit -S -m "chore: bump version to ${NEXT_VERSION}"

      - name: Push bump branch
        if: steps.release_pr.outputs.is_release == 'true'
        env:
          BUMP_BRANCH: ${{ steps.bump_branch.outputs.name }}
        run: |
          git push origin "$BUMP_BRANCH"

      - name: Create PR to develop
        if: steps.release_pr.outputs.is_release == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = `${owner}:${process.env.BUMP_BRANCH}`;
            const base = "develop";
            const title = `chore: bump version to ${process.env.NEXT_VERSION}`;
            const body = [
              "Automated version bump after release.",
              `- Release label: release/${process.env.RELEASE_LABEL}`,
              `- Released version: ${process.env.RELEASED_VERSION}`,
              `- Next version: ${process.env.NEXT_VERSION}`,
            ].join("\n");

            const { data: existing } = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              head,
              base,
            });

            if (existing.length > 0) {
              core.info(`PR already exists: #${existing[0].number}`);
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: existing[0].number,
                labels: ["kind/internal"],
              });
              return;
            }

            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              head,
              base,
              title,
              body,
            });

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr.number,
              labels: ["kind/internal"],
            });
        env:
          BUMP_BRANCH: ${{ steps.bump_branch.outputs.name }}
          NEXT_VERSION: ${{ steps.next_version.outputs.value }}
          RELEASE_LABEL: ${{ steps.bump.outputs.value }}
          RELEASED_VERSION: ${{ steps.released_version.outputs.value }}
