name: Sync main to develop

on:
  workflow_run:
    workflows: ["Deploy release"]
    types: [completed]

permissions:
  contents: write
  issues: read
  pull-requests: write

concurrency:
  group: sync-next-version
  cancel-in-progress: true

jobs:
  sync:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.BOT_PAT }}

      - name: Configure git author
        run: |
          git config user.name "Manuel GonÃ§alves"
          git config user.email "manuelmjgc@gmail.com"

      - name: Configure SSH signing key
        env:
          RELEASE_DEPLOY_KEY: ${{ secrets.RELEASE_DEPLOY_KEY }}
        run: |
          if [ -z "$RELEASE_DEPLOY_KEY" ]; then
            echo "Missing RELEASE_DEPLOY_KEY secret."
            exit 1
          fi
          mkdir -p ~/.ssh
          echo "$RELEASE_DEPLOY_KEY" > ~/.ssh/release_deploy_key
          chmod 600 ~/.ssh/release_deploy_key
          git config gpg.format ssh
          git config user.signingkey ~/.ssh/release_deploy_key
          git config commit.gpgsign true

      - name: Parse release PR labels
        id: labels
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const headBranch = context.payload.workflow_run?.head_branch;
            if (!headBranch) {
              core.setFailed('No head_branch found on workflow_run event.');
              return;
            }
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'closed',
              base: 'main',
              head: `${owner}:${headBranch}`,
              per_page: 10,
              sort: 'updated',
              direction: 'desc',
            });
            const pr = prs.find(p => p.merged_at);
            if (!pr) {
              core.setFailed(`No merged PR found for head ${headBranch} into main.`);
              return;
            }
            const names = (pr.labels || []).map(l => l.name);
            const valid = ['release/patch','release/minor','release/major'];
            const chosen = names.filter(l => valid.includes(l));
            if (chosen.length !== 1) {
              core.setFailed(`Expected exactly one release label. Found: ${chosen.join(', ') || 'none'}`);
              return;
            }
            const force = names.includes('release-mode/force');
            core.setOutput('bump', chosen[0].split('/')[1]);
            core.setOutput('force', force ? 'true' : 'false');

      - name: Create sync branch
        id: branch
        run: |
          date="$(date +%Y%m%d)"
          branch="sync/main-to-develop-${date}-${GITHUB_RUN_ID}"
          git checkout -b "$branch"
          echo "name=$branch" >> "$GITHUB_OUTPUT"

      - name: Bump version for develop
        run: |
          bump="${{ steps.labels.outputs.bump }}"
          if [ "$bump" = "major" ]; then
            bump="minor"
          fi
          npm version "$bump" --no-git-tag-version
          git add package.json
          git commit -S -s -m "chore(dev): bump version for develop"

      - name: Push sync branch
        run: |
          git push origin "HEAD:${{ steps.branch.outputs.name }}"

      - name: Create sync PR
        uses: actions/github-script@v7
        env:
          SYNC_LABEL: kind/internal
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const label = process.env.SYNC_LABEL;
            const branch = '${{ steps.branch.outputs.name }}';

            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title: 'Sync main to develop',
              head: branch,
              base: 'develop',
              body: 'Automated sync after release to keep develop up to date with main.',
            });

            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr.number,
                labels: [label],
              });
            } catch (err) {
              core.warning(`Failed to add label "${label}": ${err.message}`);
            }
